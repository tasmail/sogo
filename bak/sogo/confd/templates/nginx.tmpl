server
{
   include /etc/nginx/mime.types;
   charset utf-8;
   override_charset on;

   listen 80;
   server_name mail.userbooster.de; 
   root /usr/lib/GNUstep/SOGo/WebServerResources/; 
   ## requirement to create new calendars in Thunderbird ##
   proxy_http_version 1.1;
   
   # Message size limit
   client_max_body_size 50m;
   client_body_buffer_size 128k;

   
   location = /
   {
      rewrite ^ https://$server_name/SOGo; 
      allow all; 
   }

   # For iOS 7
   location = /principals/
   {
      rewrite ^ https://$server_name/SOGo/dav; 
      allow all; 
   }
   location ^~/SOGo
   {
      proxy_pass http://127.0.0.1:20000; 
      proxy_redirect http://127.0.0.1:20000 default; 
      # forward user's IP address 
      proxy_set_header X-Real-IP $remote_addr; 
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
      proxy_set_header Host $host; 
      proxy_set_header x-webobjects-server-protocol HTTP/1.0; 
      proxy_set_header x-webobjects-remote-host 127.0.0.1; 
      proxy_set_header x-webobjects-server-name mail.userbooster.de; 
      proxy_set_header x-webobjects-server-url https://mail.userbooster.de;
      proxy_set_header x-webobjects-server-port 443; 
      proxy_connect_timeout 90;
      proxy_send_timeout 90;
      proxy_read_timeout 90;
      proxy_buffer_size 4k;
      proxy_buffers 4 32k;
      proxy_busy_buffers_size 64k;
      proxy_temp_file_write_size 64k;
      break;
   }
   location /SOGo.woa/WebServerResources/
   {
      alias /usr/lib/GNUstep/SOGo/WebServerResources/;
      allow all;
      expires max;
   }

   location /SOGo/WebServerResources/
   {
      alias /usr/lib/GNUstep/SOGo/WebServerResources/; 
      allow all;
      expires max;
   }

   location (^/SOGo/so/ControlPanel/Products/([^/]*)/Resources/(.*)$)
   {
      alias /usr/lib/GNUstep/SOGo/$1.SOGo/Resources/$2;
      expires max;
   }

   location (^/SOGo/so/ControlPanel/Products/[^/]*UI/Resources/.*\.(jpg|png|gif|css|js)$)
   {
      alias /usr/lib/GNUstep/SOGo/$1.SOGo/Resources/$2;
      expires max;
   }

   location ^~ /Microsoft-Server-ActiveSync 
   {
      access_log /var/log/nginx/activesync.log;
      error_log  /var/log/nginx/activesync-error.log;
      
      proxy_connect_timeout 1000;
      proxy_next_upstream timeout error;
      proxy_send_timeout 1000;
      proxy_read_timeout 1000;
      proxy_buffer_size 8k;
      proxy_buffers 4 32k;
      proxy_temp_file_write_size 64k;
      proxy_busy_buffers_size 64k;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_set_header x-webobjects-server-protocol HTTP/1.0;
      proxy_set_header x-webobjects-remote-host $remote_addr;
      proxy_set_header x-webobjects-server-name mail.userbooster.de;
      proxy_set_header x-webobjects-server-url https://mail.userbooster.de;
      proxy_set_header x-webobjects-server-port $server_port;
      client_body_buffer_size 128k;

      client_max_body_size 100m;      
      proxy_pass http://127.0.0.1:20000/SOGo/Microsoft-Server-ActiveSync;
      proxy_redirect http://127.0.0.1:20000/Microsoft-Server-ActiveSync /;
   }
   
   location ^~ /SOGo/Microsoft-Server-ActiveSync 
   {
      proxy_pass http://127.0.0.1:20000/SOGo/Microsoft-Server-ActiveSync;
      proxy_redirect http://127.0.0.1:20000/SOGo/Microsoft-Server-ActiveSync /;
   }
}
